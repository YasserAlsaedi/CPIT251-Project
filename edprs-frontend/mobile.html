<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- EXACT PURPLE DESIGN --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; color: #333; }
        
        /* DEBUG BAR */
        #debug-bar { background: #333; color: #0f0; padding: 10px; text-align: center; font-family: monospace; font-size: 12px; margin-bottom: 10px; border-radius: 8px; }

        /* Container */
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; min-height: 80vh; padding-bottom: 20px; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 1px solid #eee; background: #fff; }
        .header h2 { color: #667eea; font-size: 1.4rem; margin: 0; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 35px; height: 35px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Content */
        .content { padding: 25px; }

        /* Status Toggle */
        .status-card { background: #f8f9fa; padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 20px; margin-bottom: 25px; border: 1px solid #eee; cursor: pointer; }
        .toggle { width: 60px; height: 32px; background: #10b981; border-radius: 16px; position: relative; transition: 0.3s; }
        .toggle.offline { background: #e5e7eb; }
        .toggle::after { content: ''; position: absolute; top: 4px; left: 32px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle.offline::after { left: 4px; }
        
        /* Alert */
        #alert-banner { background: #fff7ed; border: 1px solid #fdba74; color: #c2410c; padding: 20px; border-radius: 12px; margin-bottom: 25px; display: none; align-items: center; gap: 15px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* Cards */
        .card { border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; margin-bottom: 25px; display: none; }
        .card-header { background: #f9fafb; padding: 15px 20px; font-weight: bold; color: #374151; border-bottom: 1px solid #e5e7eb; }
        .card-body { padding: 20px; }
        
        .info-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .info-label { color: #6b7280; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; }
        .info-value { font-weight: 600; color: #111; font-size: 1.1rem; }
        
        .btn { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .btn-accept { background: #10b981; color: white; }
        .btn-reject { background: #ef4444; color: white; }
        .btn-submit { background: #667eea; color: white; }
        .btn-group { display: flex; gap: 15px; margin-top: 15px; }
        .btn-logout { background: #333; color: #ccc; margin-top: 30px; }

        /* Form */
        .form-section { color: #667eea; font-size: 0.9rem; font-weight: bold; text-transform: uppercase; margin: 20px 0 10px; border-bottom: 2px solid #f3f4f6; padding-bottom: 5px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 0.9rem; }
        .input-group input, textarea, select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; background: #f9fafb; }
        
        #empty-state { text-align: center; color: #888; padding: 50px; }
        
        /* Login Screen */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; }
        .login-box h2 { color: #667eea; margin-bottom: 10px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 1.1rem; }
        .btn-login { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>Unit Console Login</h2>
            <p style="margin-bottom:20px; color:#666">Enter your credentials</p>
            <input type="text" id="login-user" class="login-input" placeholder="Username (e.g. medic1)">
            <input type="password" id="login-pass" class="login-input" placeholder="Password">
            <button class="btn-login" onclick="login()">Login</button>
            <div id="login-error" style="color:red; margin-top:10px;"></div>
        </div>
    </div>

    <div id="debug-bar">Initializing...</div>

    <div class="container" id="app-container" style="display:none">
        <div class="header">
            <h2 id="header-unit">Unit Console</h2>
            <div class="user-info">
                <div class="avatar">P</div>
                <div id="user-display">PARAMEDIC</div>
            </div>
        </div>

        <div class="content">
            <div class="status-card" onclick="toggleStatus()">
                <div id="toggle-btn" class="toggle"></div>
                <div>
                    <div id="status-text" style="font-weight: bold; color: #10b981; font-size: 1.1rem;">OFFLINE</div>
                    <span style="font-size:0.8rem; color:#666">Click to change status</span>
                </div>
            </div>

            <div id="empty-state">
                <h2>Waiting...</h2>
                <p>No active cases.</p>
            </div>

            <div id="alert-banner" style="display:none">
                <span style="font-size: 1.5rem;">üîî</span>
                <div>
                    <strong style="font-size: 1.1rem;">New Case Available!</strong>
                    <div>Tap Accept to claim</div>
                </div>
            </div>

            <div id="mission-card" class="card">
                <div class="card-header">Mission Details</div>
                <div class="card-body">
                    <div class="info-row">
                        <div><div class="info-label">CASE ID</div><div class="info-value" id="m-id">...</div></div>
                        <div><div class="info-label">TYPE</div><div class="info-value" id="m-type">...</div></div>
                    </div>
                    <div class="input-group">
                        <div class="info-label">LOCATION</div>
                        <div class="info-value" id="m-loc">...</div>
                    </div>
                    <div class="input-group">
                        <div class="info-label">DESCRIPTION</div>
                        <div class="info-value" id="m-desc">...</div>
                    </div>
                    
                    <div id="decision-buttons" class="btn-group">
                        <button class="btn btn-reject" onclick="rejectCase()">‚ùå REJECT</button>
                        <button class="btn btn-accept" onclick="acceptCase()">‚úÖ ACCEPT</button>
                    </div>
                </div>
            </div>

            <div id="report-card" class="card">
                <div class="card-header">Medical Report (ePCR)</div>
                <div class="card-body">
                    <div class="form-section" style="margin-top:0">Patient Info</div>
                    <div class="input-group"><label>Patient Name</label><input id="r-name" type="text"></div>
                    <div class="form-row">
                        <div class="input-group"><label>Age</label><input id="r-age" type="number"></div>
                        <div class="input-group"><label>Gender</label><select id="r-gender"><option>Male</option><option>Female</option></select></div>
                    </div>

                    <div class="form-section">Vital Signs</div>
                    <div class="form-row">
                        <div class="input-group"><label>Heart Rate</label><input id="r-pulse" type="number"></div>
                        <div class="input-group"><label>BP</label><input id="r-bp" type="text"></div>
                    </div>
                    <div class="form-row">
                        <div class="input-group"><label>Temp (¬∞C)</label><input id="r-temp" type="number" step="0.1"></div>
                        <div class="input-group"><label>O2 (%)</label><input id="r-o2" type="number"></div>
                    </div>

                    <div class="form-section">Clinical</div>
                    <div class="input-group"><label>Complaint</label><input id="r-complaint" type="text"></div>
                    <div class="input-group"><label>Interventions</label><textarea id="r-interventions" rows="2"></textarea></div>
                    <div class="form-section">Outcome</div>
                    <div class="input-group"><label>Final Outcome</label><select id="r-outcome"><option>Transported to Hospital</option><option>Treated on Scene</option><option>Refused Transport</option><option>Deceased on Scene</option></select></div>
                    <div class="input-group"><label>Notes</label><textarea id="r-notes" rows="3"></textarea></div>

                    <button class="btn btn-submit" onclick="submitReport()">üíæ SUBMIT REPORT</button>
                </div>
            </div>

            <button class="btn btn-logout" onclick="endShift()">üö™ END SHIFT</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script>
        const API = 'http://localhost:8080/api';
        let AUTH = '';
        let MY_ID = null;
        let MY_STATUS = 'OFFLINE';
        let CURRENT_CASE = null;
        let REJECTED_IDS = []; // Local ignore list

        // USER DATABASE MAPPING
        const MEDIC_DB = {
            'medic1': { pass: '123', unitCode: 'AMB-01', name: 'A. Hassan' },
            'medic2': { pass: '123', unitCode: 'AMB-01', name: 'M. Ali' },
            'medic3': { pass: '123', unitCode: 'AMB-02', name: 'F. Ahmed' },
            'medic4': { pass: '123', unitCode: 'AMB-02', name: 'S. Khan' },
            'medic5': { pass: '123', unitCode: 'AMB-03', name: 'K. Omar' },
            'medic6': { pass: '123', unitCode: 'AMB-03', name: 'L. Saleh' },
            'medic7': { pass: '123', unitCode: 'AMB-04', name: 'N. Fahad' },
            'medic8': { pass: '123', unitCode: 'AMB-04', name: 'O. Yasser' }
        };

        function log(msg) { document.getElementById('debug-bar').innerText = msg; }

        // 1. LOGIN LOGIC (FETCH REAL ID)
        async function login() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            const user = MEDIC_DB[u];

            if (user && user.pass === p) {
                AUTH = 'Basic ' + btoa(u + ':' + p);
                
                // GET REAL ID from Server based on Code
                try {
                    const res = await fetch(`${API}/units`, { headers: { 'Authorization': AUTH }});
                    const units = await res.json();
                    const realUnit = units.find(un => un.code === user.unitCode);
                    
                    if(realUnit) {
                        MY_ID = realUnit.id;
                        MY_STATUS = realUnit.status;
                        document.getElementById('header-unit').innerText = "Unit: " + user.unitCode;
                        document.getElementById('user-display').innerText = user.name;
                        document.getElementById('login-overlay').style.display = 'none';
                        document.getElementById('app-container').style.display = 'block';
                        
                        updateStatusUI();
                        connectWS();
                        setInterval(scanForCases, 2000);
                        scanForCases();
                    } else {
                        alert("Backend Error: Unit Code not found in DB.");
                    }
                } catch(e) { alert("Server Error. Is Java Running?"); }
            } else {
                document.getElementById('login-error').innerText = "Invalid Credentials";
            }
        }

        // 2. STATUS LOGIC
        async function toggleStatus() {
            const newStatus = (MY_STATUS === 'READY') ? 'NOT_READY' : 'READY';
            await setStatus(newStatus);
        }
        async function setStatus(s) {
            try {
                await fetch(`${API}/units/${MY_ID}/status?status=${s}`, {method:'PUT', headers:{'Authorization':AUTH}});
                MY_STATUS = s;
                updateStatusUI();
                scanForCases();
            } catch(e) { log("Status Error"); }
        }
        function updateStatusUI() {
            const btn = document.getElementById('toggle-btn');
            const txt = document.getElementById('status-text');
            if(MY_STATUS === 'READY') {
                btn.classList.remove('offline'); btn.classList.remove('not-ready');
                txt.innerText = "SYSTEM ONLINE (READY)"; txt.style.color="#10b981";
            } else {
                btn.classList.add('offline'); txt.innerText = "OFFLINE / BUSY"; txt.style.color="#666";
            }
        }

        async function endShift() {
            if(confirm("End Shift?")) {
                await setStatus('OFFLINE');
                location.reload();
            }
        }

        // 3. SCAN LOGIC
        async function scanForCases() {
            if(!MY_ID) return;
            try {
                const res = await fetch(`${API}/cases/active`, { headers: { 'Authorization': AUTH }});
                const cases = await res.json();

                const myCase = cases.find(c => c.assignedUnit && c.assignedUnit.id === MY_ID);
                const pendingCase = cases.find(c => c.status === 'Pending' && !REJECTED_IDS.includes(c.id));

                if (myCase) {
                    if (!CURRENT_CASE || CURRENT_CASE.id !== myCase.id || CURRENT_CASE.status !== myCase.status) {
                        CURRENT_CASE = myCase;
                        renderAcceptedUI(myCase);
                    }
                    log("On Mission");
                } else if (pendingCase && MY_STATUS === 'READY') {
                    if (!CURRENT_CASE || CURRENT_CASE.id !== pendingCase.id) {
                        CURRENT_CASE = pendingCase;
                        renderPendingUI(pendingCase);
                    }
                    log("New Case Available");
                } else {
                    resetUI();
                    log("Idle...");
                }
            } catch(e) { log("Connection Error"); }
        }

        // 4. UI RENDERERS
        function renderPendingUI(c) {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('mission-card').style.display = 'block';
            document.getElementById('alert-banner').style.display = 'flex';
            document.getElementById('decision-buttons').style.display = 'flex';
            document.getElementById('report-card').style.display = 'none';

            document.getElementById('m-id').innerText = c.caseNumber;
            document.getElementById('m-type').innerText = c.type;
            document.getElementById('m-loc').innerText = c.location;
            document.getElementById('m-desc').innerText = c.description;
        }

        function renderAcceptedUI(c) {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('mission-card').style.display = 'block';
            document.getElementById('alert-banner').style.display = 'none';
            document.getElementById('decision-buttons').style.display = 'none';
            document.getElementById('report-card').style.display = 'block';

            document.getElementById('m-id').innerText = c.caseNumber;
            document.getElementById('m-type').innerText = c.type;
            document.getElementById('m-loc').innerText = c.location;
            document.getElementById('m-desc').innerText = c.description;
        }

        function resetUI() {
            CURRENT_CASE = null;
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('mission-card').style.display = 'none';
            document.getElementById('report-card').style.display = 'none';
            document.getElementById('alert-banner').style.display = 'none';
        }

        // 5. ACTIONS
        async function acceptCase() {
            try {
                const res = await fetch(`${API}/cases/${CURRENT_CASE.id}/accept?unitId=${MY_ID}`, {method:'PUT', headers:{'Authorization':AUTH}});
                if(res.ok) {
                    scanForCases(); // Will switch to Accepted UI
                } else {
                    alert("Too late! Case taken.");
                    scanForCases();
                }
            } catch(e) { console.error(e); }
        }

        async function rejectCase() {
            if(CURRENT_CASE) {
                REJECTED_IDS.push(CURRENT_CASE.id); // Ignore locally
                resetUI();
            }
        }

        async function submitReport() {
            const data = {
                patientName: document.getElementById('r-name').value,
                age: document.getElementById('r-age').value ? parseInt(document.getElementById('r-age').value) : null,
                gender: document.getElementById('r-gender').value,
                bloodPressure: document.getElementById('r-bp').value,
                pulse: parseInt(document.getElementById('r-pulse').value),
                temperature: parseFloat(document.getElementById('r-temp').value),
                o2Saturation: parseInt(document.getElementById('r-o2').value),
                chiefComplaint: document.getElementById('r-complaint').value,
                interventions: document.getElementById('r-interventions').value,
                outcome: document.getElementById('r-outcome').value,
                paramedicNotes: document.getElementById('r-notes').value
            };
            await fetch(`${API}/reports/${CURRENT_CASE.id}`, {
                method:'POST', headers:{'Authorization':AUTH, 'Content-Type':'application/json'},
                body: JSON.stringify(data)
            });
            alert("Report Sent!");
            await setStatus('READY'); // Back to Ready
        }

        function connectWS() {
            const s = new SockJS(`${API.replace('/api','')}/ws-emergency`);
            const c = Stomp.over(s); c.debug = null;
            c.connect({}, () => {
                c.subscribe('/topic/unit-alerts', () => setTimeout(scanForCases, 500));
            });
        }
    </script>
</body>
</html>
